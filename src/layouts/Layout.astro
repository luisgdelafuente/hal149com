---

// Consolidated CSS import for optimal loading performance
import '../assets/css/main.css'

import { Font } from 'astro:assets';

import Image from "astro/components/Image.astro"
import bg_image from "../assets/theme-images/hero-image.jpg"

import { getLangFromUrl, useTranslations } from '../i18n/ui';

import DialogModal from "../components/DialogModal.astro"
import FooterMain from "../components/FooterMain.astro"
import HeaderMain from "../components/HeaderMain.astro"

import global_settings from "../data/global_settings.json"

const { title, description, image, type = "website", author, publishedTime, modifiedTime, section, tags, ogTitle, ogDescription, twitterTitle, twitterDescription } = Astro.props
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Try to load i18n content, fallback to original
let i18nContent;
try {
  i18nContent = await import(`../i18n/content/${lang}.json`);
} catch (error) {
  console.warn(`Could not load i18n content for ${lang}, using fallback`);
}

// Use i18n content if available, otherwise use original
const globalSettings = i18nContent?.default?.global_settings || global_settings;

// Navigation data loaded from i18n content or fallback

---

<html lang={lang}>

  <head>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

    <!-- Primary Meta Tags -->
    <title>{ title ?? globalSettings.title }</title>
    <meta name="title" content={ title ?? globalSettings.title } />
    <meta name="description" content={ description ?? globalSettings.description } />
    
    <meta name="author" content={ author ?? globalSettings.author ?? "HAL149" } />
    <meta name="robots" content="index, follow" />
    <meta name="language" content={lang === 'es' ? 'es' : 'en'} />
    <meta name="revisit-after" content="7 days" />
    <meta name="theme-color" content={ globalSettings.theme_color } />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content={ type } />
    <meta property="og:url" content={ Astro.url.href } />
    <meta property="og:title" content={ ogTitle ?? globalSettings.og_title ?? title ?? globalSettings.title } />
    <meta property="og:description" content={ ogDescription ?? globalSettings.og_description ?? description ?? globalSettings.description } />
    <meta property="og:image" content={ image ? (image.startsWith('http') ? image : Astro.url.origin + image) : Astro.url.origin + globalSettings.social_image } />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:alt" content={ title ?? globalSettings.title } />
    <meta property="og:image:type" content="image/webp" />
    <meta property="og:image:secure_url" content={ image ? (image.startsWith('http') ? image : Astro.url.origin + image) : Astro.url.origin + globalSettings.social_image } />
    <meta property="og:site_name" content="HAL149" />
    <meta property="og:locale" content={lang === 'es' ? 'es_ES' : 'en_US'} />
    <meta property="og:locale:alternate" content={lang === 'es' ? 'en_US' : 'es_ES'} />
    <meta property="og:determiner" content="the" />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@hal149" />
    <meta name="twitter:creator" content="@hal149" />
    <meta name="twitter:title" content={ twitterTitle ?? globalSettings.twitter_title ?? title ?? globalSettings.title } />
    <meta name="twitter:description" content={ twitterDescription ?? globalSettings.twitter_description ?? description ?? globalSettings.description } />
    <meta name="twitter:image" content={ image ? (image.startsWith('http') ? image : Astro.url.origin + image) : Astro.url.origin + globalSettings.social_image } />
    <meta name="twitter:image:alt" content={ title ?? globalSettings.title } />
    <meta name="twitter:image:width" content="1200" />
    <meta name="twitter:image:height" content="630" />

    <!-- Additional SEO Meta Tags -->
    {publishedTime && <meta property="article:published_time" content={publishedTime} />}
    {modifiedTime && <meta property="article:modified_time" content={modifiedTime} />}
    {section && <meta property="article:section" content={section} />}
    {tags && tags.map((tag: string) => <meta property="article:tag" content={tag} />)}
    
    <!-- Enhanced SEO meta tags -->
    <meta name="application-name" content="HAL149" />
    <meta name="msapplication-TileColor" content={ globalSettings.theme_color } />
    <meta name="msapplication-config" content="/browserconfig.xml" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="theme-color" content={ globalSettings.theme_color } />
    <meta name="color-scheme" content="dark" />
    


    <!-- Structured Data / JSON-LD -->
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": type === "article" ? "Article" : "Organization",
      "name": title ?? globalSettings.title,
      "description": description ?? globalSettings.description,
      "url": Astro.url.href,
      "logo": Astro.url.origin + "/192.png",
      "image": image ? (image.startsWith('http') ? image : Astro.url.origin + image) : Astro.url.origin + globalSettings.social_image,
      "sameAs": globalSettings.social_links?.map((link: any) => link.link) || [],
      "address": {
        "@type": "PostalAddress",
        "addressCountry": "ES"
      },
      "contactPoint": {
        "@type": "ContactPoint",
        "contactType": "customer service"
      }
    })} />

    <!-- hreflang tags for SEO -->
    <link rel="alternate" hreflang="en" href={Astro.url.origin + Astro.url.pathname.replace(/^\/es/, '')} />
    <link rel="alternate" hreflang="es" href={Astro.url.origin + (Astro.url.pathname.startsWith('/es') ? Astro.url.pathname : '/es' + Astro.url.pathname)} />
    <link rel="alternate" hreflang="x-default" href={Astro.url.origin + Astro.url.pathname.replace(/^\/es/, '')} />

    <!-- Canonical URL -->
    <link rel="canonical" href={Astro.url.origin + (lang === 'en' ? Astro.url.pathname : Astro.url.pathname.replace(/^\/es/, ''))} />

    <!-- Favicon - PNG icons only -->
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/manifest.json" />

    <!-- Font optimization with preload for better performance -->
    <Font cssVariable="--font-inter" preload />
    <Font cssVariable="--font-inter-display" preload />

    <!-- Performance optimization: Preload critical resources -->
    <link rel="preload" href="/favicon-32x32.png" as="image" type="image/png" />
    <link rel="preload" href={globalSettings.social_image} as="image" type="image/png" />
    
    <!-- Performance optimization: DNS prefetch for external resources -->
    <link rel="dns-prefetch" href="//fonts.googleapis.com" />
    <link rel="dns-prefetch" href="//www.google-analytics.com" />
    
    <!-- Performance optimization: Resource hints -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    
    <!-- Performance optimization: Critical CSS inline -->
    <style>
      /* Critical CSS for above-the-fold content */
      :root {
        --font-display: var(--font-inter-display), "ui-sans-serif", "system-ui", "sans-serif";
        --font-body: var(--font-inter), "ui-sans-serif", "system-ui", "sans-serif";
        --color-bs-surface-0: #121212;
        --color-bs-surface-1: #18181B;
        --color-bs-surface-2: rgba(255, 255, 255, 0.03);
        --color-bs-surface-3: #2F2F31;
        --color-bs-foreground-light: #eee;
        --color-bs-foreground-dark: #9f9f9f;
      }
      body {
        background-color: var(--color-bs-surface-1);
        color: var(--color-bs-foreground-light);
        font-family: var(--font-body);
        margin: 0;
        padding: 0;
        /* Font optimization: Prevent layout shift during font loading */
        font-display: swap;
      }
      .bs-container {
        inline-size: min(92vw, 90rem);
        margin-inline: auto;
      }
      /* Font loading optimization: Reduce layout shift */
      .bs-h1, .bs-h2, .bs-h3 {
        font-display: swap;
      }
    </style>

  </head>

  <body id="top">

    <!-- Skip link -->
    <a class="fixed -top-20 focus-visible:top-0 p-3 bg-black/90 transition-all duration-300" href="#main">{t('skip.content')}</a>

    <!-- bg image -->
    <Image src={ bg_image } alt="" format="avif" height={1080} width={1920} class="absolute min-h-svh object-cover inset-0 bottom-auto -z-1 w-full h-auto opacity-20 mask-b-from-50%" loading="eager" />

    <!-- Header -->
    <HeaderMain settings={ globalSettings } />

    <!-- Main slot -->
    <main id="main">
      <slot />
    </main>

    <!-- Footer -->
    <FooterMain settings={ globalSettings } />

    <!-- Demo dialog modal -->
    <DialogModal id="demo" content={ globalSettings.demo } />

    <!-- Hidden form for Netlify detection -->
    <form name="contact" data-netlify="true" data-netlify-honeypot="bot-field" hidden>
      <input type="text" name="name" />
      <input type="text" name="company" />
      <input type="email" name="email" />
      <input name="bot-field" />
    </form>

    <!-- Hidden newsletter form for Netlify detection -->
    <form name="newsletter" data-netlify="true" data-netlify-honeypot="bot-field" hidden>
      <input type="text" name="name" />
      <input type="email" name="email" />
      <input name="bot-field" />
    </form>

  </body>
</html>

