---

// Consolidated CSS import for optimal loading performance
import '../assets/css/main.css'

import { Font } from 'astro:assets';

import Image from "astro/components/Image.astro"
import bg_image from "../assets/theme-images/hero-image.jpg"

import { getLangFromUrl, useTranslations } from '../i18n/ui';

import DialogModal from "../components/DialogModal.astro"
import FooterMain from "../components/FooterMain.astro"
import HeaderMain from "../components/HeaderMain.astro"

import global_settings from "../data/global_settings.json"

const { title, description, image, type = "website", author, publishedTime, modifiedTime, section, tags, ogTitle, ogDescription, twitterTitle, twitterDescription, post } = Astro.props
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Try to load i18n content, fallback to original
let i18nContent;
try {
  i18nContent = await import(`../i18n/content/${lang}.json`);
} catch (error) {
  console.warn(`Could not load i18n content for ${lang}, using fallback`);
}

// Use i18n content if available, otherwise use original
const globalSettings = i18nContent?.default?.global_settings || global_settings;

// Navigation data loaded from i18n content or fallback

// Use relative paths for images and absolute URLs only for page URLs
const pageUrl = Astro.url.href;
const resolvedImageUrl = image
  ? (image.startsWith('http') ? image : image)
  : globalSettings.social_image;

// Generate proper canonical and hreflang URLs for posts
let canonicalUrl = Astro.url.origin + Astro.url.pathname;
let hreflangEn = Astro.url.origin + Astro.url.pathname.replace(/^\/es/, '');
let hreflangEs = Astro.url.origin + (Astro.url.pathname.startsWith('/es') ? Astro.url.pathname : '/es' + Astro.url.pathname);

// If this is a blog post with translation data, use proper slug relationships
if (post && post.data) {
  const currentSlug = post.slug;
  const currentLang = post.data.lang;
  
  if (currentLang === 'en' && post.data.esSlug) {
    // English post - canonical to itself, hreflang to Spanish version
    canonicalUrl = Astro.url.origin + `/posts/${currentSlug}/`;
    hreflangEn = Astro.url.origin + `/posts/${currentSlug}/`;
    hreflangEs = Astro.url.origin + `/es/posts/${post.data.esSlug}/`;
  } else if (currentLang === 'es' && post.data.enSlug) {
    // Spanish post - canonical to English version, hreflang to both
    canonicalUrl = Astro.url.origin + `/posts/${post.data.enSlug}/`;
    hreflangEn = Astro.url.origin + `/posts/${post.data.enSlug}/`;
    hreflangEs = Astro.url.origin + `/es/posts/${currentSlug}/`;
  }
}

---

<html lang={lang}>

  <head>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

    <!-- Primary Meta Tags -->
    <title>{ title ?? globalSettings.title }</title>
    <meta name="title" content={ title ?? globalSettings.title } />
    <meta name="description" content={ description ?? globalSettings.description } />
    
    <meta name="author" content={ author ?? globalSettings.author ?? "HAL149" } />
    <meta name="robots" content="index, follow" />
    <meta name="language" content={lang === 'es' ? 'es' : 'en'} />
    <meta name="revisit-after" content="7 days" />
    <meta name="theme-color" content={ globalSettings.theme_color } />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content={ type } />
    <meta property="og:url" content={ pageUrl } />
    <meta property="og:title" content={ ogTitle ?? title ?? globalSettings.og_title ?? globalSettings.title } />
    <meta property="og:description" content={ ogDescription ?? description ?? globalSettings.og_description ?? globalSettings.description } />
    <meta property="og:image" content={ resolvedImageUrl } />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:alt" content={ title ?? globalSettings.title } />
    <meta property="og:image:type" content="image/webp" />
    <meta property="og:image:secure_url" content={ resolvedImageUrl } />
    <meta property="og:site_name" content="HAL149" />
    <meta property="og:locale" content={lang === 'es' ? 'es_ES' : 'en_US'} />
    <meta property="og:locale:alternate" content={lang === 'es' ? 'en_US' : 'es_ES'} />
    <meta property="og:determiner" content="the" />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@hal149" />
    <meta name="twitter:creator" content="@hal149" />
    <meta name="twitter:title" content={ twitterTitle ?? title ?? globalSettings.twitter_title ?? globalSettings.title } />
    <meta name="twitter:description" content={ twitterDescription ?? description ?? globalSettings.twitter_description ?? globalSettings.description } />
    <meta name="twitter:image" content={ resolvedImageUrl } />
    <meta name="twitter:image:alt" content={ title ?? globalSettings.title } />
    <meta name="twitter:image:width" content="1200" />
    <meta name="twitter:image:height" content="630" />

    <!-- Additional SEO Meta Tags -->
    {publishedTime && <meta property="article:published_time" content={publishedTime} />}
    {modifiedTime && <meta property="article:modified_time" content={modifiedTime} />}
    {section && <meta property="article:section" content={section} />}
    {tags && tags.map((tag: string) => <meta property="article:tag" content={tag} />)}
    
    <!-- Enhanced SEO meta tags -->
    <meta name="application-name" content="HAL149" />
    <meta name="msapplication-TileColor" content={ globalSettings.theme_color } />
    <meta name="msapplication-config" content="/browserconfig.xml" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="theme-color" content={ globalSettings.theme_color } />
    <meta name="color-scheme" content="dark" />
    


    <!-- Structured Data / JSON-LD -->
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": type === "article" ? "Article" : "Organization",
      "name": title ?? globalSettings.title,
      "description": description ?? globalSettings.description,
      "url": pageUrl,
      "logo": "/192.png",
      "image": resolvedImageUrl,
      "sameAs": globalSettings.social_links?.map((link: any) => link.link) || [],
      "address": {
        "@type": "PostalAddress",
        "addressCountry": "ES"
      },
      "contactPoint": {
        "@type": "ContactPoint",
        "contactType": "customer service"
      }
    })} />

    <!-- hreflang tags for SEO -->
    <link rel="alternate" hreflang="en" href={hreflangEn} />
    <link rel="alternate" hreflang="es" href={hreflangEs} />
    <link rel="alternate" hreflang="x-default" href={hreflangEn} />

    <!-- Canonical URL -->
    <link rel="canonical" href={canonicalUrl} />

    <!-- Favicon - PNG icons only -->
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/manifest.json" />

    <!-- Font optimization with preload for better performance -->
    <Font cssVariable="--font-inter" preload />
    <Font cssVariable="--font-inter-display" preload />

    <!-- Performance optimization: Preload critical resources -->
    <link rel="preload" href="/favicon-32x32.png" as="image" type="image/png" />
    <link rel="preload" href={globalSettings.social_image} as="image" type="image/png" />
    
    <!-- Performance optimization: Preload non-critical CSS for faster loading -->
    <link rel="preload" href="/assets/styles.DHBATib1.css" as="style" onload="this.onload=null;this.rel='stylesheet'" />
    <link rel="preload" href="/assets/styles.ByxRk0J7.css" as="style" onload="this.onload=null;this.rel='stylesheet'" />
    <link rel="preload" href="/assets/styles.CIxkfWyM.css" as="style" onload="this.onload=null;this.rel='stylesheet'" />
    
    <!-- Fallback for browsers that don't support preload -->
    <noscript>
      <link rel="stylesheet" href="/assets/styles.DHBATib1.css" />
      <link rel="stylesheet" href="/assets/styles.ByxRk0J7.css" />
      <link rel="stylesheet" href="/assets/styles.CIxkfWyM.css" />
    </noscript>
    
    <!-- Performance optimization: DNS prefetch for external resources -->
    <link rel="dns-prefetch" href="//fonts.googleapis.com" />
    <link rel="dns-prefetch" href="//www.google-analytics.com" />
    
    <!-- Performance optimization: Resource hints -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    
    <!-- Performance optimization: Critical CSS inline -->
    <style>
      /* Critical CSS for above-the-fold content - Enhanced for better performance */
      :root {
        --font-display: var(--font-inter-display), "ui-sans-serif", "system-ui", "sans-serif";
        --font-body: var(--font-inter), "ui-sans-serif", "system-ui", "sans-serif";
        --color-bs-surface-0: #121212;
        --color-bs-surface-1: #18181B;
        --color-bs-surface-2: rgba(255, 255, 255, 0.03);
        --color-bs-surface-3: #2F2F31;
        --color-bs-foreground-light: #eee;
        --color-bs-foreground-dark: #9f9f9f;
        color-scheme: dark;
        scroll-behavior: smooth;
        scroll-padding-top: 2em;
      }
      
      /* Critical layout styles */
      *, :after, :before, ::backdrop {
        box-sizing: border-box;
        border: 0 solid;
        margin: 0;
        padding: 0;
      }
      
      html, :host {
        -webkit-text-size-adjust: 100%;
        tab-size: 4;
        line-height: 1.5;
        font-family: var(--font-body);
        font-feature-settings: initial;
        font-variation-settings: initial;
        -webkit-tap-highlight-color: transparent;
      }
      
      body {
        background-color: var(--color-bs-surface-1);
        color: var(--color-bs-foreground-light);
        font-family: var(--font-body);
        margin: 0;
        padding: 0;
        font-display: swap;
        -webkit-text-size-adjust: 100%;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      
      /* Critical container and layout */
      .bs-container {
        inline-size: min(92vw, 90rem);
        margin-inline: auto;
      }
      
      /* Critical typography */
      .bs-h1 {
        font-family: var(--font-display);
        font-size: 3rem;
        line-height: 1;
        font-weight: 500;
        text-wrap: balance;
        font-display: swap;
        margin: 0;
      }
      
      .bs-h2 {
        font-family: var(--font-display);
        font-size: 1.875rem;
        line-height: 1.2;
        font-weight: 500;
        text-wrap: balance;
        font-display: swap;
        margin: 0;
      }
      
      .bs-h3 {
        font-family: var(--font-display);
        font-size: 1.125rem;
        line-height: 1.75;
        font-weight: 500;
        text-wrap: balance;
        font-display: swap;
        margin: 0;
      }
      
      /* Critical button styles */
      .bs-btn {
        border-radius: 0.375rem;
        background-color: var(--color-bs-surface-3);
        padding-inline: 1.25rem;
        padding-block: 1rem;
        text-align: center;
        font-weight: 600;
        color: var(--color-bs-foreground-light);
        transition: all 0.2s ease;
        position: relative;
        overflow: clip;
        border: none;
        cursor: pointer;
        display: inline-block;
        text-decoration: none;
      }
      
      /* Critical layout utilities */
      .flex { display: flex; }
      .flex-col { flex-direction: column; }
      .items-center { align-items: center; }
      .justify-between { justify-content: space-between; }
      .justify-center { justify-content: center; }
      .gap-4 { gap: 1rem; }
      .gap-6 { gap: 1.5rem; }
      .w-full { width: 100%; }
      .h-auto { height: auto; }
      .min-h-svh { min-height: 100svh; }
      .absolute { position: absolute; }
      .relative { position: relative; }
      .inset-0 { inset: 0; }
      .top-0 { top: 0; }
      .left-0 { left: 0; }
      .right-0 { right: 0; }
      .bottom-auto { bottom: auto; }
      .z-10 { z-index: 10; }
      .-z-1 { z-index: -1; }
      .opacity-20 { opacity: 0.2; }
      .object-cover { object-fit: cover; }
      .object-center { object-position: center; }
      .object-left { object-position: left; }
      .rounded-xl { border-radius: 0.75rem; }
      .overflow-hidden { overflow: hidden; }
      .bg-bs-surface-1 { background-color: var(--color-bs-surface-1); }
      .text-bs-foreground-light { color: var(--color-bs-foreground-light); }
      .text-bs-foreground-dark { color: var(--color-bs-foreground-dark); }
      
      /* Critical responsive styles */
      @media (min-width: 768px) {
        .bs-h1 { font-size: 3.75rem; }
        .bs-h2 { font-size: 2.25rem; line-height: 1.1; }
        .bs-h3 { font-size: 1.5rem; line-height: 1.33; }
      }
      
      /* Prevent layout shift during font loading */
      .bs-h1, .bs-h2, .bs-h3 {
        font-display: swap;
      }
      
      /* Critical image styles */
      img {
        max-width: 100%;
        height: auto;
        vertical-align: middle;
        display: block;
      }
      
      /* Critical link styles */
      a {
        color: inherit;
        text-decoration: inherit;
      }
      
      /* Critical form styles */
      button, input, select, textarea {
        font: inherit;
        font-feature-settings: inherit;
        font-variation-settings: inherit;
        letter-spacing: inherit;
        color: inherit;
        opacity: 1;
        background-color: transparent;
        border-radius: 0;
      }
    </style>
    
    <!-- Performance optimization: Async CSS loading script -->
    <script>
      // Enhanced async CSS loading with fallback
      (function() {
        // Function to load CSS asynchronously
        function loadCSS(href, onload) {
          var link = document.createElement('link');
          link.rel = 'stylesheet';
          link.href = href;
          if (onload) link.onload = onload;
          document.head.appendChild(link);
        }
        
        // Load non-critical CSS after page load
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', function() {
            // Small delay to ensure critical rendering is complete
            setTimeout(function() {
              loadCSS('/assets/styles.DHBATib1.css', null);
              loadCSS('/assets/styles.ByxRk0J7.css', null);
              loadCSS('/assets/styles.CIxkfWyM.css', null);
            }, 100);
          });
        } else {
          // Page already loaded, load immediately
          loadCSS('/assets/styles.DHBATib1.css', null);
          loadCSS('/assets/styles.ByxRk0J7.css', null);
          loadCSS('/assets/styles.CIxkfWyM.css', null);
        }
        
        // Optimize font loading
        if ('fonts' in document) {
          document.fonts.ready.then(function() {
            document.documentElement.classList.add('fonts-loaded');
          });
        }
      })();
    </script>

  </head>

  <body id="top">

    <!-- Skip link -->
    <a class="fixed -top-20 focus-visible:top-0 p-3 bg-black/90 transition-all duration-300" href="#main">{t('skip.content')}</a>

    <!-- bg image -->
    <Image src={ bg_image } alt="" format="avif" height={1080} width={1920} class="absolute min-h-svh object-cover inset-0 bottom-auto -z-1 w-full h-auto opacity-20 mask-b-from-50%" loading="eager" />

    <!-- Header -->
    <HeaderMain settings={ globalSettings } />

    <!-- Main slot -->
    <main id="main">
      <slot />
    </main>

    <!-- Footer -->
    <FooterMain settings={ globalSettings } />

    <!-- Demo dialog modal -->
    <DialogModal id="demo" content={ globalSettings.demo } />

    <!-- Hidden form for Netlify detection -->
    <form name="contact" data-netlify="true" data-netlify-honeypot="bot-field" hidden>
      <input type="text" name="name" />
      <input type="text" name="company" />
      <input type="email" name="email" />
      <input name="bot-field" />
    </form>

    <!-- Hidden newsletter form for Netlify detection -->
    <form name="newsletter" data-netlify="true" data-netlify-honeypot="bot-field" hidden>
      <input type="text" name="name" />
      <input type="email" name="email" />
      <input name="bot-field" />
    </form>

  </body>
</html>

