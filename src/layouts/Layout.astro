---

// Consolidated CSS import for optimal loading performance
import '../assets/css/main.css'

import { Font } from 'astro:assets';

import Image from "astro/components/Image.astro"
import bg_image from "../assets/theme-images/hero-image.jpg"

import { getLangFromUrl, useTranslations } from '../i18n/ui';

import DialogModal from "../components/DialogModal.astro"
import FooterMain from "../components/FooterMain.astro"
import HeaderMain from "../components/HeaderMain.astro"

import global_settings from "../data/global_settings.json"

const { title, description, image, type = "website" } = Astro.props
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Try to load i18n content, fallback to original
let i18nContent;
try {
  i18nContent = await import(`../i18n/content/${lang}.json`);
} catch (error) {
  console.warn(`Could not load i18n content for ${lang}, using fallback`);
}

// Use i18n content if available, otherwise use original
const globalSettings = i18nContent?.default?.global_settings || global_settings;

// Debug: Log what data source is being used
console.log('Layout Debug - i18nContent loaded:', !!i18nContent?.default?.global_settings);
console.log('Layout Debug - Using fallback:', !i18nContent?.default?.global_settings);
console.log('Layout Debug - Navigation order:', globalSettings.nav.map((item, i) => `${i}:${item.title}`).join(', '));

---

<html lang={lang}>

  <head>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />

    <title>{ title ?? globalSettings.title }</title>

    <!-- Favicon - PNG icons only -->
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/manifest.json" />

    <meta name="description" content={ description ?? globalSettings.description } />
    <meta name="theme-color" content={ globalSettings.theme_color } />

    <!-- Open Graph -->
    <meta property="og:title" content={ title ?? globalSettings.title } />
    <meta property="og:description" content={ description ?? globalSettings.description } />
    <meta property="og:type" content={ type } />
    <meta property="og:locale" content={lang === 'es' ? 'es_ES' : 'en_US'} />
    <meta property="og:url" content={ Astro.url.href } />
    <meta
      property="og:image"
      content={ image ? (image.startsWith('http') ? image : globalSettings.base_url + image) : globalSettings.base_url + globalSettings.social_image }
    />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:site_name" content="Frontier Agency" />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={ title ?? globalSettings.title } />
    <meta name="twitter:description" content={ description ?? globalSettings.description } />
    <meta name="twitter:image" content={ image ? (image.startsWith('http') ? image : globalSettings.base_url + image) : globalSettings.base_url + globalSettings.social_image } />
    <meta name="twitter:site" content="@frontieragency" />

    <!-- hreflang tags for SEO -->
    <link rel="alternate" hreflang="en" href={Astro.url.origin + Astro.url.pathname.replace(/^\/es/, '')} />
    <link rel="alternate" hreflang="es" href={Astro.url.origin + (Astro.url.pathname.startsWith('/es') ? Astro.url.pathname : '/es' + Astro.url.pathname)} />
    <link rel="alternate" hreflang="x-default" href={Astro.url.origin + Astro.url.pathname.replace(/^\/es/, '')} />

    <!-- Canonical URL -->
    <link rel="canonical" href={Astro.url.origin + (lang === 'en' ? Astro.url.pathname : Astro.url.pathname.replace(/^\/es/, ''))} />

    <!-- Font optimization with preload for better performance -->
    <Font cssVariable="--font-inter" preload />
    <Font cssVariable="--font-inter-display" preload />

    <!-- Performance optimization: Preload critical resources -->
    <link rel="preload" href="/favicon-32x32.png" as="image" type="image/png" />
    
    <!-- Performance optimization: DNS prefetch for external resources -->
    <link rel="dns-prefetch" href="//fonts.googleapis.com" />
    <link rel="dns-prefetch" href="//www.google-analytics.com" />
    
    <!-- Performance optimization: Resource hints -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    
    <!-- Performance optimization: Critical CSS inline -->
    <style>
      /* Critical CSS for above-the-fold content */
      :root {
        --font-display: var(--font-inter-display), "ui-sans-serif", "system-ui", "sans-serif";
        --font-body: var(--font-inter), "ui-sans-serif", "system-ui", "sans-serif";
        --color-bs-surface-0: #121212;
        --color-bs-surface-1: #18181B;
        --color-bs-surface-2: rgba(255, 255, 255, 0.03);
        --color-bs-surface-3: #2F2F31;
        --color-bs-foreground-light: #eee;
        --color-bs-foreground-dark: #9f9f9f;
      }
      body {
        background-color: var(--color-bs-surface-1);
        color: var(--color-bs-foreground-light);
        font-family: var(--font-body);
        margin: 0;
        padding: 0;
        /* Font optimization: Prevent layout shift during font loading */
        font-display: swap;
      }
      .bs-container {
        inline-size: min(92vw, 90rem);
        margin-inline: auto;
      }
      /* Font loading optimization: Reduce layout shift */
      .bs-h1, .bs-h2, .bs-h3 {
        font-display: swap;
      }
    </style>

  </head>

  <body id="top">

    <!-- Skip link -->
    <a class="fixed -top-20 focus-visible:top-0 p-3 bg-black/90 transition-all duration-300" href="#main">{t('skip.content')}</a>

    <!-- bg image -->
    <Image src={ bg_image } alt="" format="avif" height={1080} width={1920} class="absolute min-h-svh object-cover inset-0 bottom-auto -z-1 w-full h-auto opacity-20 mask-b-from-50%" loading="eager" />

    <!-- Header -->
    <HeaderMain settings={ globalSettings } />

    <!-- Main slot -->
    <main id="main">
      <slot />
    </main>

    <!-- Footer -->
    <FooterMain settings={ globalSettings } />

    <!-- Demo dialog modal -->
    <DialogModal id="demo" content={ globalSettings.demo } />

    <!-- Hidden form for Netlify detection -->
    <form name="contact" data-netlify="true" data-netlify-honeypot="bot-field" hidden>
      <input type="text" name="name" />
      <input type="text" name="company" />
      <input type="email" name="email" />
      <input name="bot-field" />
    </form>

    <!-- Hidden newsletter form for Netlify detection -->
    <form name="newsletter" data-netlify="true" data-netlify-honeypot="bot-field" hidden>
      <input type="text" name="name" />
      <input type="email" name="email" />
      <input name="bot-field" />
    </form>

  </body>
</html>

