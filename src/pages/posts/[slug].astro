---
// SSR mode - fetch content from Sanity CMS at runtime
export const prerender = false;

import Layout from "../../layouts/Layout.astro";
import { getLangFromUrl } from '../../i18n/ui';
import BlogImage from '../../components/BlogImage.astro';
import { getPostBySlug, portableTextToHtml, getImageUrl, getImageAlt } from '../../lib/sanity';

// Get the slug from the URL
const { slug } = Astro.params;
const lang = getLangFromUrl(Astro.url);

// Fetch the post from Sanity
const post = await getPostBySlug(slug as string, 'en');

// If post not found, return 404
if (!post) {
  return Astro.redirect('/404');
}

// Convert Sanity dates to Date objects for display
const publishDate = new Date(post.publishDate);
const displayDate = post.updatedDate ? new Date(post.updatedDate) : publishDate;

// Convert Portable Text body to HTML
const bodyHtml = portableTextToHtml(post.body);

// Get image URL (supports both Sanity images and legacy paths)
const imageUrl = post.legacyImagePath || (post.image ? getImageUrl(post) : null);
const imageAlt = getImageAlt(post);

// Create a post object compatible with Layout props
const postData = {
  slug: post.slug.current,
  data: {
    title: post.title,
    description: post.description,
    date: publishDate,
    updated: post.updatedDate ? new Date(post.updatedDate) : undefined,
    author: post.author,
    image: imageUrl,
    lang: post.lang,
    enSlug: post.enSlug,
    esSlug: post.esSlug,
    tags: post.tags,
  }
};
---

<Layout
  title={post.seoTitle || post.title}
  description={post.seoDescription || post.description}
  image={imageUrl}
  type="article"
  author={post.author}
  publishedTime={publishDate.toISOString()}
  modifiedTime={displayDate.toISOString()}
  section="Blog"
  tags={post.tags}
  post={postData}
>

  <!-- Structured Data for Blog Post -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": post.title,
    "description": post.description,
    "author": {
      "@type": "Person",
      "name": post.author
    },
    "datePublished": publishDate.toISOString(),
    "dateModified": displayDate.toISOString(),
    "url": `${Astro.url.origin}/posts/${post.slug.current}/`,
    "image": imageUrl ? imageUrl : undefined,
    "publisher": {
      "@type": "Organization",
      "name": "HAL149",
      "url": Astro.url.origin
    },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": `${Astro.url.origin}/posts/${post.slug.current}/`
    },
    "articleSection": "Blog"
  })} />
  <article class="bs-container py-8 sm:py-12 lg:py-16 max-w-4xl">
    <!-- Breadcrumbs -->
    <nav class="mb-8" aria-label="Breadcrumb">
      <ol class="flex items-center space-x-2 text-sm text-bs-foreground-dark">
        <li>
          <a href="/" class="hover:text-bs-foreground-light transition-colors">Home</a>
        </li>
        <li class="flex items-center">
          <svg class="w-4 h-4 mx-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
          </svg>
          <a href="/posts/" class="hover:text-bs-foreground-light transition-colors">Blog</a>
        </li>
        <li class="flex items-center">
          <svg class="w-4 h-4 mx-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
          </svg>
          <span class="text-bs-foreground-light font-medium">{post.title}</span>
        </li>
      </ol>
    </nav>

    <!-- Header -->
    <header class="mb-12">
      <!-- Title -->
      <h1 class="bs-h1 mb-6 leading-tight">
        {post.title}
      </h1>

      <!-- Meta -->
      <div class="flex flex-col sm:flex-row sm:flex-wrap sm:items-center gap-2 sm:gap-4 text-bs-foreground-dark mb-8">
        {post.updatedDate ? (
          <div class="flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            <span class="font-medium">Updated:</span>
            <time datetime={displayDate.toISOString()}>
              {displayDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
            </time>
          </div>
        ) : (
          <div class="flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            <span class="font-medium">Published:</span>
            <time datetime={publishDate.toISOString()}>
              {publishDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
            </time>
          </div>
        )}
      </div>

      <!-- Featured Image -->
      {imageUrl && (
        <div class="mb-8">
          <BlogImage
            src={imageUrl}
            alt={imageAlt}
            width={800}
            height={450}
            class="w-full h-auto object-contain rounded-lg shadow-lg"
            loading="eager"
            fetchpriority="high"
            sizes="(max-width: 480px) 92vw, (max-width: 768px) 90vw, (max-width: 1200px) 800px, 800px"
            quality="mid"
          />
        </div>
      )}
    </header>

    <!-- Content -->
    <div class="post-content max-w-none mb-16" set:html={bodyHtml} />
    <hr class="my-8" />
    <div class="text-sm text-bs-foreground-dark space-y-3">
      <div class="flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
        </svg>
        <span class="font-medium">Published:</span>
        <time datetime={publishDate.toISOString()}>
          {publishDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
        </time>
      </div>
      <div class="flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
        </svg>
        <span class="font-medium">Updated:</span>
        <time datetime={displayDate.toISOString()}>
          {displayDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
        </time>
      </div>
      <div class="flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
        </svg>
        <span class="font-medium">Author:</span>
        <span>{post.author}</span>
      </div>
    </div>
  </article>
</Layout>
