---

import Layout from "../../layouts/Layout.astro"

import CaseStudiesSection from "../../components/CaseStudiesSection.es.astro"
import ClientsSection from "../../components/ClientsSection.astro"
import FaqSection from "../../components/FaqSection.es.astro"
import ServicesCarousel from "../../components/ServicesCarousel.es.astro"
import HeroSection from "../../components/HeroSection.astro"
import LatestPostsSection from "../../components/LatestPostsSection.es.astro"
import NewsletterSection from "../../components/NewsletterSection.astro"
import PricingSection from "../../components/PricingSection.es.astro"
import QuoteSection from "../../components/QuoteSection.astro"
import TestimonialsSection from "../../components/TestimonialsSection.astro"

import { getLangFromUrl } from '../../i18n/ui';

// Import existing JSON data
import caseStudies from "../../data/case_studies.json"
import clients from "../../data/clients.json"
import services from "../../data/services.json"
import testimonials from "../../data/testimonials.json"
import home from "../../data/home.json"
import global_settings from "../../data/global_settings.json"
import newsletter from "../../data/newsletter.json"

// Load content based on language
const lang = getLangFromUrl(Astro.url);

// Try to load i18n content, fallback to original
let i18nContent;
try {
  i18nContent = await import(`../../i18n/content/${lang}.json`);
} catch (error) {
  console.warn(`Could not load i18n content for ${lang}, using fallback`);
}

// Use i18n content if available, otherwise use original
const homeContent = i18nContent?.default?.home || home;
const globalSettings = i18nContent?.default?.global_settings || global_settings;
const newsletterContent = i18nContent?.default?.newsletter || newsletter;
const caseStudiesContent = i18nContent?.default?.case_studies || caseStudies;
const servicesContent = i18nContent?.default?.services || services;
const faqContent = i18nContent?.default?.faq || [];

// Get homepage sections configuration
const sections = globalSettings.homepage_sections || {
  hero: true,
  services: true,
  clients: true,
  quote: true,
  case_studies: true,
  testimonials: true,
  latest_posts: true,
  pricing: true,
  faq: true,
  newsletter: true
};

---

<Layout>

  {sections.hero && (
    <HeroSection
      content={ homeContent.hero_content }
      settings={ globalSettings }
      title={ homeContent.hero_title }
    />
  )}

  {sections.services && (
    <ServicesCarousel
      services={ servicesContent }
      title={ homeContent.services_title }
    />
  )}

  {sections.clients && (
    <ClientsSection
      clients={ clients }
      title={ homeContent.clients_title }
    />
  )}

  {sections.quote && (
    <QuoteSection
      cite={ homeContent.quote_cite }
      content={ homeContent.quote_content }
      image={ homeContent.quote_image }
      role={ homeContent.quote_role }
    />
  )}

  {sections.case_studies && (
    <CaseStudiesSection
      caseStudies={ caseStudiesContent }
      title={ homeContent.case_studies_title }
    />
  )}

  {sections.testimonials && (
    <TestimonialsSection
      testimonials={ testimonials }
      title={ homeContent.testimonials_title }
    />
  )}

  {sections.latest_posts && (
    <LatestPostsSection />
  )}

  {sections.pricing && (
    <PricingSection
      title={ homeContent.pricing_title }
    />
  )}

  {sections.faq && (
    <FaqSection
      faq={ faqContent }
      title={ homeContent.faq_title }
    />
  )}

  {sections.newsletter && (
    <NewsletterSection newsletter={newsletterContent} />
  )}

</Layout>

<script>
  // Ensure Spanish cookie is set when visiting Spanish homepage
  (function() {
    // Check if we're on the Spanish homepage
    if (window.location.pathname !== '/es/' && window.location.pathname !== '/es') return;
    
    // Check if language cookie already exists and is correct
    const cookieMatch = document.cookie.match(/(?:^|;\s*)lang=(en|es)/);
    
    // Set or update cookie to Spanish
    if (!cookieMatch || cookieMatch[1] !== 'es') {
      document.cookie = 'lang=es; Path=/; Max-Age=31536000; SameSite=Lax';
    }
  })();
</script>