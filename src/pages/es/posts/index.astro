---
// SSR mode - fetch content from Sanity CMS at runtime
export const prerender = false;

import Layout from "../../../layouts/Layout.astro";
import { getLangFromUrl } from '../../../i18n/ui';
import BlogSearch from "../../../components/BlogSearch.astro";
import BlogImage from '../../../components/BlogImage.astro';
import { getPostsPaginated, getPostCount, type SanityPost } from '../../../lib/sanity';

// Get all posts from Sanity
const { posts, total } = await getPostsPaginated('es', 1, 9);

// Calculate pagination
const postsPerPage = 9;
const currentPage = 1;
const totalPages = Math.ceil(total / postsPerPage);

// Helper to get display date
function getDisplayDate(post: SanityPost): Date {
  return post.updatedDate ? new Date(post.updatedDate) : new Date(post.publishDate);
}

// Helper to get image URL
function getPostImageUrl(post: SanityPost): string | null {
  return post.legacyImagePath || null;
}

const lang = getLangFromUrl(Astro.url);
---

<Layout>

  <!-- Structured Data for Blog Archive -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "Blog",
    "name": "Blog de HAL149",
    "description": "Últimas noticias, insights y actualizaciones de HAL149",
    "url": "/es/posts/",
    "publisher": {
      "@type": "Organization",
      "name": "HAL149",
      "url": "/"
    },
    "blogPost": posts.map(post => ({
      "@type": "BlogPosting",
      "headline": post.title,
      "description": post.description,
      "author": {
        "@type": "Person",
        "name": post.author
      },
      "datePublished": new Date(post.publishDate).toISOString(),
      "dateModified": getDisplayDate(post).toISOString(),
      "url": `/es/posts/${post.slug.current}/`,
      "image": getPostImageUrl(post) || undefined,
      "publisher": {
        "@type": "Organization",
        "name": "HAL149"
      }
    }))
  })} />
  <div class="bs-container py-16">
    <!-- Header -->
    <div class="text-center mb-16">
      <h1 class="bs-h1 mb-6">Blog</h1>
      <p class="bs-body-text xl:text-xl max-w-2xl mx-auto text-bs-foreground-dark">
        Tecnología IA, Proyectos, Noticias HAL149
      </p>
    </div>

    <!-- Search Component -->
    <BlogSearch lang="es" />

    <!-- Posts Grid -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 lg:gap-8 mb-16" data-posts-grid>
      {posts.map(post => {
        const displayDate = getDisplayDate(post);
        const imageUrl = getPostImageUrl(post);
        return (
          <article class="@container group" data-post-id={post.slug.current}>
            <div class="relative isolate flex h-full w-full flex-col overflow-hidden rounded-xl bg-bs-surface-0/90 hover:bg-bs-surface-2/70 transition-colors duration-300">
              {imageUrl && (
                <div class="aspect-16-9 overflow-hidden">
                  <a href={`/es/posts/${post.slug.current}/`} class="block w-full h-full">
                    <BlogImage
                      src={imageUrl}
                      alt={post.title}
                      width={400}
                      height={225}
                      class="w-full h-full object-cover object-center group-hover:scale-105 transition-transform duration-300"
                      loading="lazy"
                      sizes="(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 33vw"
                    />
                  </a>
                </div>
              )}
              <div class="p-4 sm:p-6 flex flex-col gap-3 sm:gap-4 h-full">
                <h2 class="bs-h3 line-clamp-2 flex-grow-0">
                  <a href={`/es/posts/${post.slug.current}/`} class="hover:text-bs-foreground-light transition-colors">
                    {post.title}
                  </a>
                </h2>
                <p class="bs-body-text text-bs-foreground-dark line-clamp-3 flex-grow">
                  {post.description}
                </p>
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between text-sm text-bs-foreground-dark mt-auto gap-1 sm:gap-0">
                  <span>{post.author}</span>
                  <time datetime={displayDate.toISOString()}>
                    {displayDate.toLocaleDateString('es-ES', {
                      year: 'numeric',
                      month: 'long',
                      day: 'numeric'
                    })}
                  </time>
                </div>
              </div>
            </div>
          </article>
        );
      })}
    </div>

    <!-- Pagination -->
    {totalPages > 1 && (
      <div class="flex justify-center items-center gap-2" data-pagination>
        <a
          href="/es/posts/"
          class="px-4 py-2 rounded transition-colors bg-bs-surface-3 text-bs-foreground-light"
        >
          1
        </a>
        {totalPages > 1 && (
          <a
            href="/es/posts/page/2/"
            class="px-4 py-2 rounded transition-colors bg-bs-surface-0/90 text-bs-foreground-dark hover:bg-bs-surface-2/70"
          >
            2
          </a>
        )}
      </div>
    )}

    <!-- No posts message -->
    {posts.length === 0 && (
      <div class="text-center py-16">
        <div class="bg-bs-surface-0/90 rounded-xl p-8 max-w-md mx-auto">
          <h3 class="bs-h3 mb-4">No se encontraron artículos</h3>
          <p class="bs-body-text text-bs-foreground-dark">¡Vuelve pronto para ver nuevo contenido!</p>
        </div>
      </div>
    )}
  </div>
</Layout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
