---
import Layout from "../../../layouts/Layout.astro";
import { getCollection } from 'astro:content';
import { getLangFromUrl } from '../../../i18n/ui';
import BlogImage from '../../../components/BlogImage.astro';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  return posts
    .filter(post => post.data.lang === 'es')
    .map(post => ({
      params: { slug: post.slug },
      props: { post },
    }));
}

const { post } = Astro.props as { post: any };
const { Content } = await post.render();

const lang = getLangFromUrl(Astro.url);
---

<Layout 
  title={post.data.title}
  description={post.data.description}
  image={post.data.image}
  type="article"
  author={post.data.author}
  publishedTime={post.data.date.toISOString()}
  modifiedTime={post.data.date.toISOString()}
  section="Blog"
  tags={post.data.tags}
  post={post}
>
  
  <!-- Structured Data for Blog Post -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": post.data.title,
    "description": post.data.description,
    "author": {
      "@type": "Person",
      "name": post.data.author
    },
    "datePublished": post.data.date.toISOString(),
    "dateModified": post.data.date.toISOString(),
    "url": `${Astro.url.origin}/es/posts/${post.slug}/`,
    "image": post.data.image ? `${Astro.url.origin}${post.data.image}` : undefined,
    "publisher": {
      "@type": "Organization",
      "name": "HAL149",
      "url": Astro.url.origin
    },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": `${Astro.url.origin}/es/posts/${post.slug}/`
    },
    "articleSection": "Blog"
  })} />
  <article class="bs-container py-8 sm:py-12 lg:py-16 max-w-4xl">
    <!-- Breadcrumbs -->
    <nav class="mb-8" aria-label="Breadcrumb">
      <ol class="flex items-center space-x-2 text-sm text-bs-foreground-dark">
        <li>
          <a href="/es/" class="hover:text-bs-foreground-light transition-colors">Inicio</a>
        </li>
        <li class="flex items-center">
          <svg class="w-4 h-4 mx-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
          </svg>
          <a href="/es/posts/" class="hover:text-bs-foreground-light transition-colors">Blog</a>
        </li>
        <li class="flex items-center">
          <svg class="w-4 h-4 mx-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
          </svg>
          <span class="text-bs-foreground-light font-medium">{post.data.title}</span>
        </li>
      </ol>
    </nav>

    <!-- Header -->
    <header class="mb-12">
      <!-- Title -->
      <h1 class="bs-h1 mb-6 leading-tight">
        {post.data.title}
      </h1>

      <!-- Meta -->
      <div class="flex flex-col sm:flex-row sm:flex-wrap sm:items-center gap-2 sm:gap-4 text-bs-foreground-dark mb-8">
        <div class="flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
          </svg>
          <span>{post.data.author}</span>
        </div>
        <div class="flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 002 2v12a2 2 0 002 2z"></path>
          </svg>
          <time datetime={post.data.date.toISOString()}>
            {post.data.date.toLocaleDateString('es-ES', { 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric' 
            })}
          </time>
        </div>
      </div>

      <!-- Featured Image -->
      {post.data.image && (
        <div class="mb-8">
          <BlogImage 
            src={post.data.image} 
            alt={post.data.title}
            width={800}
            height={450}
            class="w-full h-auto object-contain rounded-lg shadow-lg"
            loading="eager"
            fetchpriority="high"
            sizes="(max-width: 480px) 92vw, (max-width: 768px) 90vw, (max-width: 1200px) 800px, 800px"
            quality="high"
          />
        </div>
      )}
    </header>

    <!-- Content -->
    <div class="post-content max-w-none mb-16">
      <Content />
    </div>
  </article>
</Layout>

<style is:global>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  /* Post content styling with high specificity */
  article .post-content {
    font-family: var(--font-body);
    color: #e5e7eb !important;
    line-height: 1.8 !important;
    font-size: 1.125rem !important;
    max-width: none;
  }
  
  article .post-content * {
    color: inherit;
  }
  
  /* Headings - All levels */
  article .post-content h1 {
    font-family: var(--font-display) !important;
    font-size: 2.5rem !important;
    line-height: 1.2 !important;
    margin: 3rem 0 1.5rem 0 !important;
    font-weight: 700 !important;
    color: #ffffff !important;
  }
  
  article .post-content > h1:first-child {
    display: none !important;
  }
  
  article .post-content h2 {
    font-family: var(--font-display) !important;
    font-size: 1.875rem !important;
    line-height: 1.3 !important;
    margin: 2.5rem 0 1.25rem 0 !important;
    font-weight: 600 !important;
    color: #ffffff !important;
    border-bottom: 2px solid #374151 !important;
    padding-bottom: 0.5rem !important;
  }
  
  article .post-content h3 {
    font-family: var(--font-display) !important;
    font-size: 1.5rem !important;
    line-height: 1.4 !important;
    margin: 2rem 0 1rem 0 !important;
    font-weight: 600 !important;
    color: #f3f4f6 !important;
  }
  
  article .post-content h4 {
    font-family: var(--font-display) !important;
    font-size: 1.25rem !important;
    line-height: 1.5 !important;
    margin: 1.75rem 0 0.75rem 0 !important;
    font-weight: 600 !important;
    color: #d1d5db !important;
  }
  
  article .post-content h5,
  article .post-content h6 {
    font-family: var(--font-display) !important;
    font-size: 1.125rem !important;
    line-height: 1.5 !important;
    margin: 1.5rem 0 0.5rem 0 !important;
    font-weight: 600 !important;
    color: #d1d5db !important;
  }
  
  /* Paragraphs */
  article .post-content p {
    margin-bottom: 1.5rem !important;
    color: #e5e7eb !important;
    line-height: 1.75 !important;
  }
  
  article .post-content h1 + p,
  article .post-content h2 + p,
  article .post-content h3 + p,
  article .post-content h4 + p,
  article .post-content h5 + p,
  article .post-content h6 + p {
    margin-top: 0 !important;
  }
  
  /* Lists */
  article .post-content ul,
  article .post-content ol {
    margin: 1.5rem 0 !important;
    padding-left: 1.75rem !important;
    color: #e5e7eb !important;
    list-style: revert !important;
  }
  
  article .post-content ul {
    list-style-type: disc !important;
  }
  
  article .post-content ol {
    list-style-type: decimal !important;
  }
  
  article .post-content li {
    margin-bottom: 0.5rem !important;
    line-height: 1.6 !important;
    color: #e5e7eb !important;
    list-style: inherit !important;
  }
  
  article .post-content ul li::marker,
  article .post-content ol li::marker {
    color: #9ca3af !important;
  }
  
  article .post-content li > p {
    margin-bottom: 0.5rem !important;
  }
  
  article .post-content ul ul,
  article .post-content ol ol,
  article .post-content ul ol,
  article .post-content ol ul {
    margin: 0.5rem 0 !important;
  }
  
  /* Blockquotes */
  article .post-content blockquote {
    border-left: 4px solid #6b7280 !important;
    margin: 2rem 0 !important;
    padding: 1.25rem 1.5rem !important;
    font-style: italic !important;
    color: #d1d5db !important;
    background-color: #374151 !important;
    border-radius: 0.5rem !important;
    font-size: 1.125rem !important;
    line-height: 1.6 !important;
  }
  
  article .post-content blockquote p {
    margin-bottom: 0.75rem !important;
    color: #d1d5db !important;
  }
  
  article .post-content blockquote p:last-child {
    margin-bottom: 0 !important;
  }
  
  /* Code blocks - CRITICAL FIX */
  article .post-content code {
    background-color: #374151 !important;
    color: #f8fafc !important;
    padding: 0.25rem 0.5rem !important;
    border-radius: 0.375rem !important;
    font-size: 0.875rem !important;
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace !important;
    border: 1px solid #4b5563 !important;
    font-weight: 500 !important;
    display: inline-block !important;
  }
  
  article .post-content pre {
    background-color: #1f2937 !important;
    color: #f8fafc !important;
    padding: 1.5rem !important;
    border-radius: 0.75rem !important;
    overflow-x: auto !important;
    margin: 2rem 0 !important;
    border: 1px solid #374151 !important;
    font-size: 0.875rem !important;
    line-height: 1.6 !important;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3) !important;
  }
  
  article .post-content pre code {
    background-color: transparent !important;
    padding: 0 !important;
    border: none !important;
    color: #f8fafc !important;
    font-size: inherit !important;
    font-weight: 400 !important;
    display: block !important;
  }
  
  /* Force code block text to be white */
  article .post-content pre * {
    color: #f8fafc !important;
  }
  
  /* Images */
  article .post-content img {
    border-radius: 0.75rem !important;
    margin: 2.5rem 0 !important;
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3) !important;
    max-width: 100% !important;
    height: auto !important;
  }
  
  /* Links */
  article .post-content a {
    color: #60a5fa !important;
    text-decoration: underline !important;
    text-decoration-color: #3b82f6 !important;
    text-underline-offset: 3px !important;
    transition: all 0.2s ease !important;
  }
  
  article .post-content a:hover {
    color: #93c5fd !important;
    text-decoration-color: #60a5fa !important;
    text-decoration-thickness: 2px !important;
  }
  
  /* Text emphasis */
  article .post-content strong {
    color: #ffffff !important;
    font-weight: 700 !important;
  }
  
  article .post-content em {
    color: #f3f4f6 !important;
    font-style: italic !important;
  }
  
  /* Horizontal rules */
  article .post-content hr {
    border: none !important;
    height: 1px !important;
    background: #374151 !important;
    margin: 3rem 0 !important;
  }
  
  /* Tables */
  article .post-content table {
    width: 100% !important;
    border-collapse: collapse !important;
    margin: 2rem 0 !important;
    background-color: #1f2937 !important;
    border-radius: 0.5rem !important;
    overflow: hidden !important;
  }
  
  article .post-content th,
  article .post-content td {
    padding: 0.75rem 1rem !important;
    text-align: left !important;
    border-bottom: 1px solid #374151 !important;
  }
  
  article .post-content th {
    background-color: #374151 !important;
    font-weight: 600 !important;
    color: #f3f4f6 !important;
  }
  
  article .post-content td {
    color: #e5e7eb !important;
  }
  
  /* First and last elements */
  article .post-content > *:first-child {
    margin-top: 0 !important;
  }
  
  article .post-content > *:last-child {
    margin-bottom: 0 !important;
  }

  /* Mobile responsive typography */
  @media (max-width: 768px) {
    /* Hide last breadcrumb item (title) on mobile */
    nav[aria-label="Breadcrumb"] ol li:last-child {
      display: none !important;
    }
    
    /* Main blog title override */
    .bs-h1 {
      font-size: 1.75rem !important;
      line-height: 1.3 !important;
    }
    
    article .post-content {
      font-size: 1rem !important;
    }
    
    article .post-content h1 {
      font-size: 1.75rem !important;
      margin: 2rem 0 1rem 0 !important;
    }
    
    article .post-content h2 {
      font-size: 1.5rem !important;
      margin: 2rem 0 1rem 0 !important;
    }
    
    article .post-content h3 {
      font-size: 1.25rem !important;
      margin: 1.5rem 0 0.75rem 0 !important;
    }
    
    article .post-content h4 {
      font-size: 1.125rem !important;
      margin: 1.25rem 0 0.5rem 0 !important;
    }
    
    article .post-content h5,
    article .post-content h6 {
      font-size: 1rem !important;
      margin: 1rem 0 0.5rem 0 !important;
    }
    
    article .post-content p {
      margin-bottom: 1.25rem !important;
    }
    
    article .post-content blockquote {
      font-size: 1rem !important;
      padding: 1rem 1.25rem !important;
      margin: 1.5rem 0 !important;
    }
  }
</style>