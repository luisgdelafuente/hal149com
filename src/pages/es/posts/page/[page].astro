---
// SSR mode - fetch content from Sanity CMS at runtime
export const prerender = false;

import Layout from "../../../../layouts/Layout.astro";
import BlogImage from '../../../../components/BlogImage.astro';
import BlogSearch from "../../../../components/BlogSearch.astro";
import { getPostsPaginated, type SanityPost } from '../../../../lib/sanity';

// Get page number from URL
const { page: pageParam } = Astro.params;
const currentPage = parseInt(pageParam as string) || 1;
const postsPerPage = 9;

// Fetch posts from Sanity
const { posts, total } = await getPostsPaginated('es', currentPage, postsPerPage);
const totalPages = Math.ceil(total / postsPerPage);

// Redirect to main posts page if page 1 or invalid page
if (currentPage === 1) {
  return Astro.redirect('/es/posts/');
}
if (currentPage < 1 || currentPage > totalPages) {
  return Astro.redirect('/es/posts/');
}

// Helper functions
function getDisplayDate(post: SanityPost): Date {
  return post.updatedDate ? new Date(post.updatedDate) : new Date(post.publishDate);
}

function getPostImageUrl(post: SanityPost): string | null {
  return post.legacyImagePath || null;
}
---

<Layout>
  <div class="bs-container py-16">
    <div class="text-center mb-16">
      <h1 class="bs-h1 mb-6">Blog</h1>
      <p class="bs-body-text xl:text-xl max-w-2xl mx-auto text-bs-foreground-dark">
        Tecnolog√≠a IA, Proyectos, Noticias HAL149
      </p>
    </div>

    <!-- Search Component -->
    <BlogSearch lang="es" />

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 lg:gap-8 mb-16" data-posts-grid>
      {posts.map(post => {
        const displayDate = getDisplayDate(post);
        const imageUrl = getPostImageUrl(post);
        return (
          <article class="@container group" data-post-id={post.slug.current}>
            <div class="relative isolate flex h-full w-full flex-col overflow-hidden rounded-xl bg-bs-surface-0/90 hover:bg-bs-surface-2/70 transition-colors duration-300">
              {imageUrl && (
                <div class="aspect-16-9 overflow-hidden">
                  <a href={`/es/posts/${post.slug.current}/`} class="block w-full h-full">
                    <BlogImage
                      src={imageUrl}
                      alt={post.title}
                      width={400}
                      height={225}
                      class="w-full h-full object-cover object-center group-hover:scale-105 transition-transform duration-300"
                      loading="lazy"
                      sizes="(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 33vw"
                    />
                  </a>
                </div>
              )}
              <div class="p-4 sm:p-6 flex flex-col gap-3 sm:gap-4 h-full">
                <h2 class="bs-h3 line-clamp-2 flex-grow-0">
                  <a href={`/es/posts/${post.slug.current}/`} class="hover:text-bs-foreground-light transition-colors">
                    {post.title}
                  </a>
                </h2>
                <p class="bs-body-text text-bs-foreground-dark line-clamp-3 flex-grow">
                  {post.description}
                </p>
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between text-sm text-bs-foreground-dark mt-auto gap-1 sm:gap-0">
                  <span>{post.author}</span>
                  <time datetime={displayDate.toISOString()}>
                    {displayDate.toLocaleDateString('es-ES', {
                      year: 'numeric',
                      month: 'long',
                      day: 'numeric'
                    })}
                  </time>
                </div>
              </div>
            </div>
          </article>
        );
      })}
    </div>

    {totalPages > 1 && (
      <div class="flex justify-center items-center gap-2" data-pagination>
        {currentPage > 1 && (
          <a href={currentPage - 1 === 1 ? '/es/posts/' : `/es/posts/page/${currentPage - 1}/`} class="bs-btn">
            Anterior
          </a>
        )}

        {Array.from({ length: totalPages }, (_, i) => i + 1).map(p => (
          <a
            href={p === 1 ? '/es/posts/' : `/es/posts/page/${p}/`}
            class={`px-4 py-2 rounded transition-colors ${
              p === currentPage
                ? 'bg-bs-surface-3 text-bs-foreground-light'
                : 'bg-bs-surface-0/90 text-bs-foreground-dark hover:bg-bs-surface-2/70'
            }`}
          >
            {p}
          </a>
        ))}

        {currentPage < totalPages && (
          <a href={`/es/posts/page/${currentPage + 1}/`} class="bs-btn">
            Siguiente
          </a>
        )}
      </div>
    )}
  </div>
</Layout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
